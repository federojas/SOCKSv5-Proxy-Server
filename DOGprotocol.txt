TODO: ACLARAR LO DE LITTLE ENDIAN O BIG ENDIAN EN UNA SECCION ESPECIFICA

                        SOCKS Authentication Protocol 

Status of this Memo

   This document specifies an Internet standards track protocol for the
   Internet community, and requests discussion and suggestions for
   improvements.  


Acknowledgments

   This document describes a protocol that is designed to interact with a Socks5d
   server and obtain metrics from it. It is a session oriented protocol which works 
   over TCP. 

1.  Introduction

   This protocol is intended to provide tools for a client in order to obtain certain 
   information over a running Socks5d server. The client can make requests asking for 
   the historic amount of connections over the server, the quantity of concurrent connections
   in the server and the quantity of bytes transfered in the server, between other things. This protocol does not 
   assure that the metrics are non volatile, meaning that if the server reboots, the statistics 
   may be lost. 
   As this protocol is  session oriented, operations such as adding or deleting user,
   setting a password and ending a connection, are needed.

   Based on socks5d protocol and Username/Password Authentication for SOCKS V5 (rfc 1928 and 1929).

   The commands supported can be divided in 3 sub-sections:
      o  Get request
      o  Alterations request
      o  Ending connection
   
   The associated commands values for Get requests are the following:
      o  Get the list of users
      o  Get the historic amount of connections over the server
      o  Get the concurrent connections quantity
      o  Get the quantity of bytes transfered in the server
      o  Get the status of the password spoofing over the server
      o  Get the status of the password spoofing over the server
      o  Get access to the logs of the server

   
   The associated CMD values for Alterations request are the following:
      o  Add a user 
      o  Delete a user 
      o  Set a new password 
      o  Set a user admin priviledges
      o  Toggle password spoofing in the server
      o  Toggle authentication in the server
    

2.  Initial negotiation
    
   The client establishes a TCP connection with the server.
   
   Once the connection with the SOCKS V5 server has started, the client
   must send the log in data by producing an Username/Password request:

           +----+------+----------+------+----------+
           |VER | ULEN |  UNAME   | PLEN |  PASSWD  |
           +----+------+----------+------+----------+
           | 1  |  1   | 1 to 255 |  1   | 1 to 255 |
           +----+------+----------+------+----------+
           
   The VER field contains the current version of the subnegotiation,
   which is 0x00.

      o The ULEN field contains the length of the UNAME field that follows.
      o The UNAME field contains the username as known to the source operating system (in ASCII charset).
      o The PLEN field contains the length of the PASSWD field that follows.
      o The PASSWD field contains the password association with the given UNAME.

   The server verifies the supplied UNAME and PASSWD, and sends the
   following response:
   
                        +----+--------+
                        |VER | STATUS |
                        +----+--------+
                        | 1  |   1    |
                        +----+--------+

   o A STATUS field of 0x00 indicates connection succedeed.
   o A STATUS field of 0x01 indicates connection failed by incorrect user/password
   o A STATUS field of 0x02 indicates an invalid version
   o A STATUS field of 0x03 indicates a server error
  
   In case of failure, the server returns a 'failure' (any STATUS value different than 0x00)
   status, it MUST close the connection.
   
   In case of succesfull connection (STATUS value 0x00), the session is established.


3.  GET Commands
                     +------+-----+
                     | TYPE | CMD |
                     +------+-----+
                     
                     +------+-----+

   3.1   GET Requests  
      
      The value of TYPE is a 1 byte long unsigned integer field and its value for GET requests is
      0x00 while the CMD is a 1 byte long unsigned integer field and its value varies
      according to which command is needed.

      3.1.1   List of users  
         
         CMD value 0x00. Command used to get a list of all users in the server.

      3.1.2   Historic amount of connections

         CMD value 0x01. Command used to get the historic amount of connections over the server.

      3.1.3   Quantity of current  connections
         
         CMD value 0x02. Command used quantity of current connections.

      3.1.4   Quantity of bytes transfered  
         
         CMD value 0x03. Command used to get the quantity of bytes transfered in the server.
      
      3.1.5   Current status of the password disector  

         CMD value 0x04. Command used to get the status of the password disector over the server (over POP3 protocol).

      3.1.6   Bytes transfered from a user  TODO: ESTO NO SE SI ES MEDIO UNA FLASHEADA

         CMD value 0x05. Command used to get amount of bytes transfered by a specific user, the request adds to the 
         base structure the following fields.

                     +------+-----+------+----------+
                     | TYPE | CMD | ULEN |  UNAME   |
                     +------+-----+-----------------|
                     |   1  |  1  |  1   | 1 to 255 |
                       +------+-----+------+--------+
         In which:
               o The ULEN field contains the length of the UNAME field that follows.
               o The UNAME field contains the username as known to the source operating system.
         
         It is relevant to state that only users with admin priviledges are allowed to use this request.

         
      3.1.7   Access to the logs of the server

         CMD value 0x06. Command used to access the logs over the server.
         It is relevant to state that only users with admin priviledges are allowed to use this request.

      

   3.2   Get Responses

      every server response will contain a general base structure as it follows
      (and then according to each request can add different parameters):

                     +----------+
                     |  STATUS  |
                     +----------+
                     |    1     |
                     +----------+

      In which  STATUS is a 1 byte long unsigned integer refering to the request status,
      and its values can be:

         o 0x00 succedeed
         o 0x01 general server failure
         o 0x02 unsupported type
         o 0x03 unsupported command


      3.2.1   List of users  
         
         TODO: PREGUNTAR ESTE
         The list of users command returns content within the following structure:

                  +----------+------------+
                  |  STATUS  |   USRS     |
                  +----------+------------+
                  |    1     |  Variable  |
                  +----------+------------+

         Where:TODO:ESCRIBIR BIEN 
         o  STATUS can take the values previously specified.
         o  USRS refers to the user list itself in ASCII charset, where the first byte indicates the username lenght.

      3.2.2   Historic amount of connections over the server
   
         The historic amount of connections over the server command returns content within the following structure:

                  +----------+-------+
                  |  STATUS  |  QTY  |
                  +----------+-------+
                  |    1     |   8   |
                  +----------+-------+
         
         Where: 
         TODO: los 8  bytes son pensados en funcion de escalabilidad pero realmente a nosotros con 2 nos alcanza no?
         o  STATUS can take the values previously specified.
         o  QTY is a 8 byte long unsigned integer related to the amount of bytes transfered.

      3.2.3   Quantity of current  connections
   
         The quantity of current connections command returns content within the following structure:

                  +----------+-------+
                  |  STATUS  |  QTY  |
                  +----------+-------+
                  |    1     |   2   |
                  +----------+-------+
         Where:

         o  STATUS can take the values previously specified.
         o  QTY is a 2 byte long unsigned integer related to the amount of users listed.


      3.2.4   Quantity of bytes transfered  
   
         The quantity of bytes transfered command returns content within the following structure:

                  +----------+-------+
                  |  STATUS  |  QTY  |
                  +----------+-------+
                  |    1     |   8   |
                  +----------+-------+

         Where:

         o  STATUS can take the values previously specified.
         o  QTY is a 8 byte long unsigned integer related to the amount of bytes transfered.
      
      3.2.5   Current status of the password disector 
            
         The current status of the password disector over the server (over POP3 protocol) returns content within the following structure:

                  +----------+---------------+
                  |  STATUS  |    SPOOFING   |
                  +----------+---------------+
                  |    1     |       1       |
                  +----------+---------------+

         o  STATUS can take the values previously specified.
         o  SPOOFING 1 byte long unsigned integer in which: 
            
            0x00 means that the spoofing is turned OFF.
            0x01 means that the spoofing is turned ON.

      3.2.6  Bytes transfered from a user  
         
         The amount of bytes transfered by a specific user returns content within the following structure:
         
                  +----------+-------+------+----------+
                  |  STATUS  |  QTY  | ULEN |  UNAME   |
                  +----------+-------+------+----------+
                  |    1     |   8   |  1   | 1 to 255 |
                  +----------+-------+------+----------+
         
         o  STATUS can take the values previously specified.
         o  QTY is a 8 byte long unsigned integer related to the amount of bytes transfered.                             
         o  The ULEN field contains the length of the UNAME field that follows.
         o  The UNAME field contains the username related to the request.    
                     
      3.2.7  Access to the logs of the server
      TODO: ESTO NO SE MUY BIEN SI TA BIEN (PROBABLEMENTE NO)
 
         Te logs from the user request returns content within the following structure:

                  +----------+-------------+-------------+
                  |  STATUS  |    QARGS    |     ARGS    |
                  +----------+-------------+-------------+
                  |    1     |      1      |   Variable  |
                  +----------+-------------+-------------+

         o  TYPE and CMD and STATUS are the values previously specified.
         o  QARGS refers to the amount of parameters to be parsed.
         o  ARGS are the arguments itself (the logs).


4.  Alterations Commands

      The value of TYPE is a 1 byte long unsigned integer field and its value for Alterations requests is
      0x01 while the CMD is a 1 byte long unsigned integer field and its value varies
      according to which command is needed.

   4.1   Alterations Requests  

      4.1.1  Add a User
            
            CMD value 0x00. Command used to add a user to the server,
            the following  structure is required:

            +-------+-----+------+----------+------+----------+----------+
            |  TYPE | CMD | ULEN |  UNAME   | PLEN |  PASSWD  |   ROLE   |
            +-------+-----+------+----------+------+----------+----------+
            |   1   |  1  |  1   | 1 to 255 |  1   | 1 to 255 |    1     |
            +-------+-----+------+----------+------+----------+----------+      

         o  ULEN is a 1 byte long unsigned integer refering to the length of the UNAME field that follows.
         o  UNAME contains the username (must be in ASCII charset).
         o  PLEN field contains a 1 byte long unsigned integer refering to the length of the PASSWD field that follows.
         o  PASSWD field contains the password association with the given UNAME (must be in ASCII charset).
         o  ROLE field contains a 1 byte long unsigned integer refering  to the role of the new user.

               0x00 for normal users
               0x01 for admin users
TODO: ANCHO FIJO PRIMERO

      4.1.2  Delete User

            To delete a user, the following  structure is required:

           +------+-----+------+----------+------+----------+
           | TYPE | CMD | ULEN |  UNAME   | PLEN |  PASSWD  |
           +------+-----+------+----------+------+----------+
           |   1  |  1  |  1   | 1 to 255 |  1   | 1 to 255 |
           +------+-----+------+----------+------+----------+

         In which TYPE and CMD values are the specified in "General request structure" section and
         ULEN, UNAME,PLEN, PASSWD and ROLE are the same fields specified in 6.1.1. 
         It is important to specify that the UNAME value must exist in order to be deleted.
         
            o In case ROLE of the user making the request is 0x00, it means that the user making the request doesn't have 
              admin priviledges, in consecuence, the password must match with the actual password of 
              the UNAME user

            o In case ROLE of the user making the request is 0x01, it means that the user making the request do have 
              admin priviledges, in consecuence, the password field will not be evaluated.

            o In case authentication is turned off the password field will not be evaluated.
        
         TODO: NO SE SI TA BIEN ESTE PLANTEO DEL ADMIN priviledges,
          SI SOY ADMIN PODRIA DIRECTAMENTE NO MANDAR NADA EN LA CONTRASEÑA?
           PQ POR AHORA AUNQUE SEA ADMIN TENGO QUE MANDAR ALGO DE CONTENIDO EN LA CONTRASEÑA
            (QUE NO VA A SER EVALUADO PERO HAY QUE MANDARLO IGUAL)



      4.1.3  Set new Password

            To set a  new password for a user, the following  structure is required:

           +------+-----+------+----------+------+----------+------------+------------------+
           | TYPE | CMD | ULEN |  UNAME   | PLEN |  PASSWD  |  PLEN.NEW  |     PASSWD.NEW   |
           +------+-----+------+----------+------+----------+------------+------------------+
           |   1  |  1  |  1   | 1 to 255 |  1   | 1 to 255 |     1      |      1 to 255    |
           +------+-----+------+----------+------+----------+------------+------------------+
TODO: SACAR PASSWORD VIEJA

         In which TYPE and  CMD values are the specified in "General request structure" section
         and ULEN, UNAME, PLEN, PASSWD and ROLE are the same fields specified in 6.1.1. 
         PLEN.NEW and PASSWD.NEW have the same structure type as PLEN and PASSWD and contains the new password 
         specifications.
         It is important to specify that the UNAME value must exist in order to be deleted.

            o In case ROLE of the user making the request is 0x00, it means that the user making the request doesn't have 
              admin priviledges, in consecuence, the password must match with the actual password of 
              the UNAME user

            o In case ROLE of the user making the request is 0x01, it means that the user making the request do have 
              admin priviledges, in consecuence, the password field will not be evaluated.
            
            o In case authentication is turned off the password field will not be evaluated.

      4.1.3  Give a user admin priviledges

            //TODO: ESTO NO SE SI ESTA BIEN, CUALQUIER USUARIO PODRIA HACERSE ADMIN

            To set a  new password for a user, the following  structure is required:

                  +------+-----+------+----------+------+----------+
                  | TYPE | CMD | ULEN |  UNAME   |
                  +------+-----+------+----------+-
                  |   1  |  1  |  1   | 1 to 255 |  1   | 1 to 255 |
                  +------+-----+------+----------+------+----------+

           In which the fields are the same specified in 6.1.1 and in 2.
           It is relevant to state that this command can only be excecuted by users with admin role, meaning 
           that only an admin can make an existing user admin.
           In any other case, the request will not be evaluated, EXCEPT authentication is turned off. 
           This case is analogous to the case that an admin user is making the request.

      4.1.4 Toggle password spoofing

            In order to toggle password spoofing in the server, the client MUST have admin priviledges.
            This request must contain the following structure:
            
                  +--------+-------+---------------+
                  |  TYPE  |  CMD  |   SPOOFING    |
                  +--------+-------+---------------+
                  |   1    |   1   |       1       |
                  +--------+-------+---------------+

            As it was previously specified, in this case TYPE must be 0x01 and CMD must be 0x04
            and SPOOFING is a 1 byte long unsigned integer.
               0x00 to turn spoofing OFF
               0x01 to turn spoofing ON 
   
      4.1.5 Toggle authentication in the server TODO: GETTER A ESTO
                  
                  +--------+-------+---------------+
                  |  TYPE  |  CMD  |     AUTH      |
                  +--------+-------+---------------+
                  |   1    |   1   |       1       |
                  +--------+-------+---------------+

            In which AUTH is a 1 byte long unsigned integer and its values can be:
               0x00 to turn authentication OFF
               0x01 to turn authentication ON 

   4.2   Modification Responses  

         All modification requests have the following response structure:

                  +----------+
                  |  STATUS  |
                  +----------+
                  |    1     |
                  +----------+

         STATUS can be:
         
            o 0x00 succedeed
            o 0x01 general server failure
            o 0x02 unsupported type
            o 0x03 unsupported command

5.  General request structure

   Once the client is authenticated (and in consequence, the session with the server is established).
   All client request MUST contain the following base structure (and then according to each request can add different parameters): 
   
                     +------+-----+
                     | TYPE | CMD |
                     +------+-----+
                     |   1  |  1  |
                     +------+-----+

   Where TYPE refers to the command type, which can be:
      0x00 for a Get request
      0x01 for a Alterations request
      0x02 for Ending connection
   
   and CMD refers to the specific command for each TYPE.

   The associated CMD values for Get requests are the following:
      o  0x00 to get the list of users
      o  0x01 to get the historic amount of connections over the server
      o  0x02 to get the concurrent connections quantity
      o  0x03 to get the quantity of bytes transfered in the server
      o  0x04 to get the status of the password spoofing over the server
      o  0x05 to get the status of the password spoofing over the server
      o  0x06 to get access to the logs of the server

   
   The associated CMD values for Alterations request are the following:
      o  0x00 to Add a user 
      o  0x01 to Delete a user 
      o  0x02 to set a new password 
      o  0x03 to set a user admin priviledges
      o  0x04 to toggle password spoofing in the server
      o  0x05 to toggle authentication in the server
    

      
   In case of Ending a connection no CMD value is needed. TODO: AGREGAR COMANDOS DE CMD ACA SI HACEN FALTA

6.  General response structure

   As well as in the general request structure, every server response will contain a
   general base structure as it follows (and then according to each request can add different parameters):

   TODO: TENDRIA SENTIDO SACAR EL STATUS FIELD Y Q CUANDO HAYA UN ERROR DEVUELVA UN TYPE INEXISTENTE? Y DE ESA FORMA AHORRARNOS EL BYTE DE STATUS (para mi que no)
                     +----------+
                     |  STATUS  |
                     +----------+
                     |    1     |
                     +----------+

  STATUS refers to the request status, and its values can be:

      o 0x00 succedeed
      o 0x01 general server failure
      o 0x02 unsupported type
      o 0x03 unsupported command

      TODO:  o  X'09' to X'FF' unassigned --> hace falta aclarar algo con esto? 
